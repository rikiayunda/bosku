<?php

namespace App\Controllers;

use App\Models\UserModel;

class ProfileController extends BaseController
{
    protected $userModel;

    // Constructor untuk menginisialisasi UserModel
    public function __construct()
    {
        $this->userModel = new UserModel();
    }

    public function index()
    {
      
        $userId = session()->get('userId');
        if (!$userId) {
            return redirect()->to('auth/login');
        }

        $user = $this->userModel->find($userId);
        if (!$user) {
            return redirect()->to('auth/login');
        }

        // Data untuk dikirim ke view
        $data = array(
            'title' => 'Halaman Profil',
            'isi' => 'v_profile',
            'user' => $user // Kirim data pengguna
        );

        return view('layout/v_wrapper', $data);
    }

    public function update()
    {
        
        // Cek apakah user sudah login
        $userId = session()->get('userId');
        if (!$userId) {
            return redirect()->to('/login');
        }

        // Ambil data pengguna
        $user = $this->userModel->find($userId);
        if (!$user) {
            return redirect()->to('/login');
        }
        log_message('debug', 'User from DB: ' . print_r($user, true));


        // Kumpulkan data untuk diupdate
        $data = [
            'full_name' => $this->request->getPost('full_name') ?? $user['full_name'],
            'phone' => $this->request->getPost('phone') ?? $user['phone'],
            'email' => $this->request->getPost('email') ?? $user['email'],
            'skin' => $this->request->getPost('skin') ?? $user['skin'],
        ];

        // Update password jika disediakan
        if ($this->request->getPost('new_password')) {
            $data['password'] = password_hash($this->request->getPost('new_password'), PASSWORD_DEFAULT);
        }

        // Proses upload foto
        $photo = $this->request->getFile('photo');
        if ($photo && $photo->isValid() && !$photo->hasMoved()) {
            $newName = $photo->getRandomName();
            $photo->move(WRITEPATH . 'uploads', $newName);
            $data['photo'] = $newName;
        }

        // Update data pengguna
        $this->userModel->update($userId, $data);

        return redirect()->to('/profile')->with('message', 'Profile updated successfully');
    }
}
